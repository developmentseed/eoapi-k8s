{
  "$schema": "http://json-schema.org/schema#",
  "type": "object",
  "required": [
    "service",
    "gitSha"
  ],
  "properties": {
    "gitSha": {
      "type": "string",
      "description": "Git SHA of the deployment"
    },
    "testing": {
      "type": "boolean",
      "description": "Only used in CI for running parallel helm installs",
      "default": false
    },
    "serviceAccount": {
      "type": "object",
      "properties": {
        "create": {
          "type": "boolean",
          "default": true,
          "description": "Whether to create a service account"
        },
        "name": {
          "type": "string",
          "description": "Service account name. If not set and create is true, a name is generated"
        },
        "automount": {
          "type": "boolean",
          "default": true,
          "description": "Automatically mount service account token"
        },
        "annotations": {
          "type": "object",
          "description": "Annotations to add to the service account"
        },
        "labels": {
          "type": "object",
          "description": "Labels to add to the service account"
        }
      }
    },
    "service": {
      "type": "object",
      "required": ["port"],
      "properties": {
        "port": {
          "type": "integer",
          "description": "Service port number"
        }
      }
    },
    "ingress": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable ingress"
        },
        "className": {
          "type": "string",
          "enum": ["nginx", "traefik"],
          "description": "Ingress controller class name"
        },
        "rootPath": {
          "type": "string",
          "description": "Root path for doc server"
        },
        "host": {
          "type": "string",
          "description": "Ingress host"
        },
        "hosts": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Array of multiple ingress host domains array - if specified, takes precedence over single host"
        },
        "annotations": {
          "type": "object",
          "description": "Additional annotations for ingress"
        },
        "tls": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable TLS"
            },
            "secretName": {
              "type": "string",
              "description": "TLS secret name"
            },
            "certManager": {
              "type": "boolean",
              "description": "Use cert-manager for TLS"
            },
            "certManagerIssuer": {
              "type": "string",
              "description": "cert-manager issuer to use"
            },
            "certManagerEmail": {
              "type": "string",
              "description": "Email address for cert-manager"
            }
          }
        }
      }
    },

    "postgresql": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["postgrescluster", "external-plaintext", "external-secret"],
          "description": "PostgreSQL deployment type",
          "default": "postgrescluster"
        },
        "external": {
          "type": "object",
          "properties": {
            "host": {
              "type": "string",
              "description": "External PostgreSQL host"
            },
            "port": {
              "type": "string",
              "description": "External PostgreSQL port"
            },
            "database": {
              "type": "string",
              "description": "External PostgreSQL database name"
            },
            "credentials": {
              "type": "object",
              "properties": {
                "username": {
                  "type": "string",
                  "description": "External PostgreSQL username"
                },
                "password": {
                  "type": "string",
                  "description": "External PostgreSQL password"
                }
              }
            },
            "existingSecret": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Name of existing secret"
                },
                "keys": {
                  "type": "object",
                  "properties": {
                    "username": {
                      "type": "string",
                      "description": "Username key in secret"
                    },
                    "password": {
                      "type": "string",
                      "description": "Password key in secret"
                    },
                    "host": {
                      "type": "string",
                      "description": "Host key in secret"
                    },
                    "port": {
                      "type": "string",
                      "description": "Port key in secret"
                    },
                    "database": {
                      "type": "string",
                      "description": "Database key in secret"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "postgrescluster": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable PostgreSQL cluster"
        },
        "postgresVersion": {
          "type": "integer",
          "description": "PostgreSQL version"
        },
        "postGISVersion": {
          "type": "string",
          "description": "PostGIS version"
        },
        "pgBouncerReplicas": {
          "type": "integer",
          "description": "Number of PgBouncer replicas"
        },
        "monitoring": {
          "type": "boolean",
          "description": "Enable monitoring"
        },
        "patroni": {
          "type": "object",
          "description": "Patroni configuration"
        },
        "databaseInitSQL": {
          "type": "object",
          "description": "Database initialization SQL"
        },
        "instances": {
          "type": "array",
          "description": "PostgreSQL instances configuration"
        },
        "users": {
          "type": "array",
          "description": "PostgreSQL users configuration"
        }
      }
    },
    "pgstacBootstrap": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable PgSTAC bootstrap"
        },
        "image": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "description": "PgSTAC bootstrap image name"
            },
            "tag": {
              "type": "string",
              "description": "PgSTAC bootstrap image tag"
            }
          }
        },
        "settings": {
          "type": "object",
          "properties": {
            "loadSamples": {
              "type": "boolean",
              "description": "Load sample data"
            },
            "user": {
              "type": "string",
              "description": "Database user"
            },
            "database": {
              "type": "string",
              "description": "Database name"
            },
            "resources": {
              "type": "object",
              "description": "Resource requirements"
            },
            "pgstacSettings": {
              "type": "object",
              "description": "PgSTAC database configuration settings",
              "properties": {
                "queue_timeout": {
                  "type": "string",
                  "default": "10 minutes",
                  "description": "Timeout for queued queries (PostgreSQL interval format)"
                },
                "use_queue": {
                  "type": "string",
                  "enum": ["true", "false"],
                  "default": "false",
                  "description": "Enable/disable query queue mechanism"
                },
                "update_collection_extent": {
                  "type": "string",
                  "enum": ["true", "false"],
                  "default": "true",
                  "description": "Auto-update collection extents when items are added/modified"
                },
                "context": {
                  "type": "string",
                  "enum": ["on", "off", "auto"],
                  "default": "auto",
                  "description": "Context mode for search results"
                },
                "context_estimated_count": {
                  "type": "string",
                  "default": "100000",
                  "description": "Row threshold for using estimates instead of exact counts"
                },
                "context_estimated_cost": {
                  "type": "string",
                  "default": "100000",
                  "description": "Query cost threshold for using estimates"
                },
                "context_stats_ttl": {
                  "type": "string",
                  "default": "1 day",
                  "description": "Cache duration for context statistics (PostgreSQL interval)"
                }
              }
            },
            "queueProcessor": {
              "type": "object",
              "description": "Queue processor CronJob configuration (active when use_queue is true)",
              "properties": {
                "schedule": {
                  "type": "string",
                  "default": "0 * * * *",
                  "description": "Cron schedule for processing queued queries"
                }
              }
            },
            "extentUpdater": {
              "type": "object",
              "description": "Extent updater CronJob configuration (active when update_collection_extent is false)",
              "properties": {
                "schedule": {
                  "type": "string",
                  "default": "0 2 * * *",
                  "description": "Cron schedule for updating collection extents"
                }
              }
            },
            "queryables": {
              "type": "array",
              "description": "List of queryables configurations to load using pypgstac load-queryables",
              "items": {
                "type": "object",
                "required": ["name"],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Name of the queryables configuration file"
                  },
                  "file": {
                    "type": "string",
                    "description": "Path to the queryables file relative to the chart directory"
                  },
                  "configMapRef": {
                    "type": "object",
                    "description": "Reference to an external ConfigMap containing queryables data",
                    "properties": {
                      "name": {
                        "type": "string",
                        "description": "Name of the ConfigMap"
                      },
                      "key": {
                        "type": "string",
                        "description": "Key within the ConfigMap containing the queryables data"
                      }
                    },
                    "required": ["name", "key"]
                  },
                  "indexFields": {
                    "type": "array",
                    "description": "List of fields to create database indexes for",
                    "items": {
                      "type": "string"
                    }
                  },
                  "deleteMissing": {
                    "type": "boolean",
                    "description": "Whether to delete queryables not present in this configuration"
                  },
                  "collections": {
                    "type": "array",
                    "description": "List of collection IDs to apply these queryables to",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "oneOf": [
                  {
                    "required": ["file"],
                    "not": {
                      "required": ["configMapRef"]
                    }
                  },
                  {
                    "required": ["configMapRef"],
                    "not": {
                      "required": ["file"]
                    }
                  }
                ]
              }
            }
          }
        }
      }
    },
    "apiServices": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": ["raster", "multidim", "stac", "vector"]
      },
      "description": "List of API services to enable"
    },
    "raster": {
      "$ref": "#/definitions/apiService"
    },
    "multidim": {
      "$ref": "#/definitions/apiService"
    },
    "stac": {
      "$ref": "#/definitions/apiService"
    },
    "vector": {
      "$ref": "#/definitions/apiService"
    },
    "browser": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable STAC browser"
        },
        "replicaCount": {
          "type": "integer",
          "description": "Number of replicas"
        },
        "image": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "description": "Image name"
            },
            "tag": {
              "type": "string",
              "description": "Image tag"
            }
          }
        },
        "ingress": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable ingress for browser"
            }
          }
        }
      }
    },
    "docServer": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable documentation server"
        }
      }
    },
    "eoapi-notifier": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable eoAPI notifier for database notifications to CloudEvents"
        },
        "sources": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "description": "Source type (e.g., pgstac)"
              },
              "config": {
                "type": "object",
                "description": "Source-specific configuration"
              }
            }
          },
          "description": "Notification source configurations"
        },
        "outputs": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "description": "Output type (e.g., cloudevents, mqtt)"
              },
              "config": {
                "type": "object",
                "description": "Output-specific configuration"
              }
            }
          },
          "description": "Notification output configurations"
        },
        "config": {
          "type": "object",
          "properties": {
            "logLevel": {
              "type": "string",
              "enum": ["DEBUG", "INFO", "WARNING", "ERROR"],
              "default": "INFO",
              "description": "Log level for eoapi-notifier"
            }
          }
        },
        "secrets": {
          "type": "object",
          "properties": {
            "postgresql": {
              "type": "object",
              "properties": {
                "create": {
                  "type": "boolean",
                  "description": "Create PostgreSQL secret"
                }
              }
            }
          }
        },
        "env": {
          "type": "object",
          "description": "Environment variables for eoapi-notifier"
        },
        "envFrom": {
          "type": "array",
          "description": "Environment variables from references"
        },
        "resources": {
          "type": "object",
          "description": "Resource requirements for eoapi-notifier"
        }
      }
    }
  },
  "definitions": {
    "apiService": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable the service"
        },
        "ingress": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable ingress for this service"
            }
          }
        },
        "autoscaling": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable autoscaling"
            },
            "minReplicas": {
              "type": "integer",
              "description": "Minimum number of replicas"
            },
            "maxReplicas": {
              "type": "integer",
              "description": "Maximum number of replicas"
            },
            "type": {
              "type": "string",
              "enum": ["cpu", "requestRate", "both"],
              "description": "Autoscaling metric type"
            },
            "behavior": {
              "type": "object",
              "description": "Autoscaling behavior configuration"
            },
            "targets": {
              "type": "object",
              "properties": {
                "cpu": {
                  "type": "integer",
                  "description": "CPU utilization target"
                },
                "requestRate": {
                  "type": "string",
                  "description": "Request rate target"
                }
              }
            }
          }
        },
        "image": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "description": "Image name"
            },
            "tag": {
              "type": "string",
              "description": "Image tag"
            }
          }
        },
        "command": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Container command"
        },
        "overrideRootPath": {
          "type": "string",
          "description": "Override root path for this service"
        },
        "settings": {
          "type": "object",
          "properties": {
            "labels": {
              "type": "object",
              "description": "Additional pod labels"
            },
            "resources": {
              "type": "object",
              "description": "Resource requirements"
            },
            "extraEnvFrom": {
              "type": "array",
              "description": "Additional environment variables from references"
            },
            "extraVolumeMounts": {
              "type": "array",
              "description": "Additional volume mounts"
            },
            "extraVolumes": {
              "type": "array",
              "description": "Additional volumes"
            },
            "envVars": {
              "type": "object",
              "description": "Environment variables"
            }
          }
        }
      }
    }
  }
}
