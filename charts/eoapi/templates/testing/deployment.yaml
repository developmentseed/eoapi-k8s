{{/*
TEST INFRASTRUCTURE - DO NOT USE IN PRODUCTION
This mock OIDC server is for testing stac-auth-proxy integration only.
*/}}
{{- if .Values.testing.mockOidcServer.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "eoapi.fullname" . }}-mock-oidc-server
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "eoapi.labels" . | nindent 4 }}
    app.kubernetes.io/component: mock-oidc-server
spec:
  replicas: {{ .Values.testing.mockOidcServer.replicaCount | default 1 }}
  selector:
    matchLabels:
      {{- include "eoapi.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: mock-oidc-server
  template:
    metadata:
      labels:
        {{- include "eoapi.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: mock-oidc-server
    spec:
      {{- if .Values.testing.mockOidcServer.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.testing.mockOidcServer.imagePullSecrets | nindent 8 }}
      {{- end }}
      containers:
      - name: mock-oidc
        image: "{{ if .Values.testing.mockOidcServer.image }}{{ .Values.testing.mockOidcServer.image.repository | default "ghcr.io/alukach/mock-oidc-server" }}:{{ .Values.testing.mockOidcServer.image.tag | default "latest" }}{{ else }}ghcr.io/alukach/mock-oidc-server:latest{{ end }}"
        imagePullPolicy: {{ if .Values.testing.mockOidcServer.image }}{{ .Values.testing.mockOidcServer.image.pullPolicy | default "IfNotPresent" }}{{ else }}IfNotPresent{{ end }}
        env:
        - name: MOCK_OIDC_PORT
          value: "{{ .Values.testing.mockOidcServer.port | default 8888 }}"
        - name: MOCK_OIDC_CLIENT_ID
          value: "{{ .Values.testing.mockOidcServer.clientId | default "test-client" }}"
        - name: MOCK_OIDC_CLIENT_SECRET
          value: "{{ .Values.testing.mockOidcServer.clientSecret | default "test-secret" }}"
        {{- if .Values.testing.mockOidcServer.extraEnv }}
        {{- toYaml .Values.testing.mockOidcServer.extraEnv | nindent 8 }}
        {{- end }}
        ports:
        - name: http
          containerPort: {{ .Values.testing.mockOidcServer.port | default 8888 }}
          protocol: TCP
        startupProbe:
          httpGet:
            path: /.well-known/openid-configuration
            port: http
          initialDelaySeconds: 10
          periodSeconds: 5
          failureThreshold: 12
          timeoutSeconds: 3
        livenessProbe:
          httpGet:
            path: /.well-known/openid-configuration
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 3
        readinessProbe:
          httpGet:
            path: /.well-known/openid-configuration
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5
          failureThreshold: 3
          timeoutSeconds: 3
        {{- if .Values.testing.mockOidcServer.resources }}
        resources:
          {{- toYaml .Values.testing.mockOidcServer.resources | nindent 10 }}
        {{- end }}
      {{- if .Values.testing.mockOidcServer.nodeSelector }}
      nodeSelector:
        {{- toYaml .Values.testing.mockOidcServer.nodeSelector | nindent 8 }}
      {{- end }}
      {{- if .Values.testing.mockOidcServer.affinity }}
      affinity:
        {{- toYaml .Values.testing.mockOidcServer.affinity | nindent 8 }}
      {{- end }}
      {{- if .Values.testing.mockOidcServer.tolerations }}
      tolerations:
        {{- toYaml .Values.testing.mockOidcServer.tolerations | nindent 8 }}
      {{- end }}
{{- end }}
