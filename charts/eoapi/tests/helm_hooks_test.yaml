suite: helm hooks are correctly applied
set:
  pgstacBootstrap:
    enabled: true
    settings:
      queryables:
        - name: "common-queryables.json"
          file: "data/initdb/queryables/test-queryables.json"
  eoapi-notifier:
    enabled: true
    outputs:
      - type: cloudevents
  knative:
    enabled: true
    cloudEventsSink:
      enabled: true
tests:
  - it: Knative - service
    template: templates/core/cloudevents-sink.yaml
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            helm.sh/hook: "post-install,post-upgrade"
            helm.sh/hook-weight: "10"
            helm.sh/hook-delete-policy: "before-hook-creation"
  - it: Knative - sink-binding
    template: templates/core/sink-binding.yaml
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            helm.sh/hook: "post-install,post-upgrade"
            helm.sh/hook-weight: "30"
            helm.sh/hook-delete-policy: "before-hook-creation"
  - it: Knative - job
    template: templates/core/knative-init.yaml
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            helm.sh/hook: "post-install,post-upgrade"
            helm.sh/hook-weight: "0"
            helm.sh/hook-delete-policy: "before-hook-creation,hook-succeeded"

  - it: Pgstacbootstrap - configmap
    template: templates/database/pgstacbootstrap/configmap.yaml
    set:
      pgstacBootstrap:
        configMaps:
          initdb:
            annotations:
              helm.sh/hook: "post-install,post-upgrade"
              helm.sh/hook-weight: "-7"
              helm.sh/hook-delete-policy: "before-hook-creation,hook-succeeded"
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            helm.sh/hook: "post-install,post-upgrade"
            helm.sh/hook-weight: "-7"
            helm.sh/hook-delete-policy: "before-hook-creation,hook-succeeded"

  - it: Pgstacbootstrap - eoap-superuser-initdb
    template: templates/database/pgstacbootstrap/eoap-superuser-initdb.yaml
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            helm.sh/hook: post-install,post-upgrade
            helm.sh/hook-delete-policy: before-hook-creation
            helm.sh/hook-weight: "-6"

  - it: Pgstacbootstrap - job
    template: templates/database/pgstacbootstrap/job.yaml
    asserts:
      - isSubset:
          path: metadata.annotations
          content:
            helm.sh/hook: post-install,post-upgrade
            helm.sh/hook-delete-policy: before-hook-creation
      - documentIndex: 0  # pgstac-migrate
        isSubset:
          path: metadata.annotations
          content:
            helm.sh/hook-weight: "-5"
      - documentIndex: 1  # pgstac-load-samples
        isSubset:
          path: metadata.annotations
          content:
            helm.sh/hook-weight: "-4"
      - documentIndex: 2  # pgstac-load-queryables
        isSubset:
          path: metadata.annotations
          content:
            helm.sh/hook-weight: "-3"
