suite: test ingress routing without stripPrefix middleware
templates:
  - templates/networking/ingress.yaml

tests:
  - it: should route ingress to stac-auth-proxy when enabled
    set:
      ingress.enabled: true
      ingress.className: nginx
      stac.enabled: true
      stac.ingress.enabled: true
      stac.ingress.path: "/stac"
      stac-auth-proxy.enabled: true
      service.port: 8080
    asserts:
      - contains:
          path: spec.rules[0].http.paths
          content:
            pathType: Prefix
            path: /stac
            backend:
              service:
                name: RELEASE-NAME-stac-auth-proxy
                port:
                  number: 8080

  - it: should route ingress directly to stac when auth-proxy is disabled
    set:
      ingress.enabled: true
      ingress.className: nginx
      stac.enabled: true
      stac.ingress.enabled: true
      stac.ingress.path: "/stac"
      stac-auth-proxy.enabled: false
      service.port: 8080
    asserts:
      - contains:
          path: spec.rules[0].http.paths
          content:
            pathType: Prefix
            path: /stac
            backend:
              service:
                name: RELEASE-NAME-stac
                port:
                  number: 8080

  - it: should not create ingress when both stac and browser are disabled
    set:
      ingress.enabled: true
      stac.enabled: false
      browser.enabled: false
      stac-auth-proxy.enabled: true
      raster.enabled: false
      vector.enabled: false
      multidim.enabled: false
      docServer.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should route correctly with experimental profile
    values:
      - ../profiles/experimental.yaml
    set:
      ingress.enabled: true
    asserts:
      - contains:
          path: spec.rules[0].http.paths
          content:
            pathType: Prefix
            path: /stac
            backend:
              service:
                name: RELEASE-NAME-stac-auth-proxy
                port:
                  number: 8080

  - it: should route ingress to browser with Prefix pathType
    set:
      ingress.enabled: true
      ingress.className: nginx
      browser.enabled: true
      stac.enabled: false
      raster.enabled: false
      vector.enabled: false
      multidim.enabled: false
    asserts:
      - contains:
          path: spec.rules[0].http.paths
          content:
            pathType: Prefix
            path: /browser
            backend:
              service:
                name: RELEASE-NAME-browser
                port:
                  number: 8080

  - it: should include both stac and browser when both enabled
    set:
      ingress.enabled: true
      ingress.className: nginx
      stac.enabled: true
      stac.ingress.enabled: true
      stac.ingress.path: "/stac"
      stac-auth-proxy.enabled: true
      browser.enabled: true
      service.port: 8080
    asserts:
      - contains:
          path: spec.rules[0].http.paths
          content:
            pathType: Prefix
            path: /stac
            backend:
              service:
                name: RELEASE-NAME-stac-auth-proxy
                port:
                  number: 8080
      - contains:
          path: spec.rules[0].http.paths
          content:
            pathType: Prefix
            path: /browser
            backend:
              service:
                name: RELEASE-NAME-browser
                port:
                  number: 8080

  - it: should use Prefix pathType for backend raster API
    set:
      ingress.enabled: true
      ingress.className: nginx
      raster.enabled: true
      raster.ingress.enabled: true
      raster.ingress.path: "/raster"
      service.port: 8080
    asserts:
      - contains:
          path: spec.rules[0].http.paths
          content:
            pathType: Prefix
            path: /raster
            backend:
              service:
                name: RELEASE-NAME-raster
                port:
                  number: 8080

  - it: should use Prefix pathType for backend vector API
    set:
      ingress.enabled: true
      ingress.className: nginx
      vector.enabled: true
      vector.ingress.enabled: true
      vector.ingress.path: "/vector"
      service.port: 8080
    asserts:
      - contains:
          path: spec.rules[0].http.paths
          content:
            pathType: Prefix
            path: /vector
            backend:
              service:
                name: RELEASE-NAME-vector
                port:
                  number: 8080

  - it: should route to stac-auth-proxy when stac has overrideRootPath
    set:
      ingress.enabled: true
      ingress.className: nginx
      stac.enabled: true
      stac.ingress.enabled: true
      stac.ingress.path: "/stac"
      stac.overrideRootPath: "/custom"
      stac-auth-proxy.enabled: true
      service.port: 8080
    asserts:
      - contains:
          path: spec.rules[0].http.paths
          content:
            pathType: Prefix
            path: /stac
            backend:
              service:
                name: RELEASE-NAME-stac-auth-proxy
                port:
                  number: 8080
