suite: stac browser service tests
templates:
  - templates/services/browser/deployment.yaml
  - templates/services/browser/service.yaml
tests:
  - it: "stac browser deployment"
    set:
      raster.enabled: false
      stac.enabled: false
      vector.enabled: false
      multidim.enabled: false
      browser.enabled: true
      gitSha: "ABC123"
    template: templates/services/browser/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - matchRegex:
          path: metadata.name
          pattern: ^RELEASE-NAME-browser$
      - matchRegex:
          path: metadata.labels.app
          pattern: ^RELEASE-NAME-browser$
      - equal:
          path: metadata.labels.gitsha
          value: "ABC123"
  - it: "stac browser service"
    set:
      raster.enabled: false
      stac.enabled: false
      vector.enabled: false
      multidim.enabled: false
      browser.enabled: true
      browser.annotations:
        annotation1: hello
        annotation2: world
      gitSha: "ABC123"
    template: templates/services/browser/service.yaml
    asserts:
      - isKind:
          of: Service
      - matchRegex:
          path: metadata.name
          pattern: ^RELEASE-NAME-browser$
      - matchRegex:
          path: metadata.labels.app
          pattern: ^RELEASE-NAME-browser$
      - equal:
          path: metadata.annotations.annotation1
          value: hello
      - equal:
          path: metadata.annotations.annotation2
          value: world
  - it: "stac browser deployment with auth enabled"
    set:
      raster.enabled: false
      stac.enabled: true
      vector.enabled: false
      multidim.enabled: false
      browser.enabled: true
      stac-auth-proxy.enabled: true
      stac-auth-proxy.env.OIDC_DISCOVERY_URL: "http://localhost/mock-oidc/.well-known/openid-configuration"
      ingress.host: "localhost"
      stac.ingress.path: "/stac"
      mockOidcServer.ingress.path: "/mock-oidc"
      browser.oidcClientId: "test-client"
      gitSha: "ABC123"
    template: templates/services/browser/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SB_catalogUrl
            value: "http://localhost/stac"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SB_authConfig
            value: |
              {
                "type": "openIdConnect",
                "openIdConnectUrl": "http://localhost/mock-oidc/.well-known/openid-configuration",
                "oidcOptions": {
                  "client_id": "test-client"
                }
              }
  - it: "stac browser deployment with custom OIDC_DISCOVERY_URL"
    set:
      raster.enabled: false
      stac.enabled: true
      vector.enabled: false
      multidim.enabled: false
      browser.enabled: true
      stac-auth-proxy.enabled: true
      stac-auth-proxy.env.OIDC_DISCOVERY_URL: "https://auth.example.com/.well-known/openid-configuration"
      ingress.host: "localhost"
      stac.ingress.path: "/stac"
      browser.oidcClientId: "test-client"
      gitSha: "ABC123"
    template: templates/services/browser/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SB_authConfig
            value: |
              {
                "type": "openIdConnect",
                "openIdConnectUrl": "https://auth.example.com/.well-known/openid-configuration",
                "oidcOptions": {
                  "client_id": "test-client"
                }
              }
  - it: "stac browser deployment without auth"
    set:
      raster.enabled: false
      stac.enabled: true
      vector.enabled: false
      multidim.enabled: false
      browser.enabled: true
      stac-auth-proxy.enabled: false
      ingress.host: "localhost"
      stac.ingress.path: "/stac"
      gitSha: "ABC123"
    template: templates/services/browser/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SB_catalogUrl
            value: "http://localhost/stac"
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: SB_authConfig
