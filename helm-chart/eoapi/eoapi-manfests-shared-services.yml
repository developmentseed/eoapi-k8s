---
# Source: eoapi/templates/db/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: pgstac-secrets-vector1
type: "Opaque"
stringData:
  DB_MAX_CONN_SIZE: "10"
  DB_MIN_CONN_SIZE: "1"
  PGDATA: "/var/lib/postgresql/data/pgdata"
  PGDATABASE: "postgis"
  POSTGRES_DBNAME: "postgis"
  PGPASSWORD: "password"
  POSTGRES_PASS: "password"
  PGUSER: "username"
  POSTGRES_DB: "postgis"
  POSTGRES_HOST: "pgstac"
  POSTGRES_HOST_READER: "pgstac"
  POSTGRES_HOST_WRITER: "pgstac"
  POSTGRES_PASSWORD: "password"
  POSTGRES_PORT: "5432"
  POSTGRES_USER: "username"
  TIPG_DB_SCHEMAS: '["public","vector1","vector2"]'
  TIPG_MULTI_MAPPING: '{"vector1.wfs3labs.com":{"include": ["public","vector1"], "exclude": ["vector2"]}, "vector2.wfs3labs.com":{"include": ["public","vector2"], "exclude": ["vector1"]}}'
---
# Source: eoapi/templates/services/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: vector
    gitsha: c873b20edb
  name: vector
spec:
  progressDeadlineSeconds: 600
  revisionHistoryLimit: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 50%
      maxUnavailable: 0
  selector:
    matchLabels:
      app: vector
  template:
    metadata:
      labels:
        app: vector
    spec:
      containers:
      - image: ghcr.io/ranchodeluxe/tipg:multitenantv17
        name: vector
        command:
          - "uvicorn"
        
          - "tipg.main:app"
          - "--host=$(HOST)"
          - "--port=$(PORT)"
        ports:
          - containerPort: 8080
        resources:
          limits:
            cpu: 512m
            memory: 1024Mi
          requests:
            cpu: 256m
            memory: 256Mi
        envFrom:
          # NOTE: there's no reason we need to use a `ConfigMap` or `Secret` here to get os env vars into the pod.
          # we could just template them out here immediately with `value: $_` but this allows us
          # to store them in k8s intermediately and change them and then bounce deploys if needed
        - secretRef:
            name: pgstac-secrets-vector1
        - configMapRef:
            name: vector-envvar-configmap
---
# Source: eoapi/templates/services/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: vector
  name: vector
spec:
  type: "NodePort"
  ports:
  - name: '8080'
    port: 8080
    targetPort: 8080
  selector:
    app: vector
---
# Source: eoapi/templates/services/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-envvar-configmap
data:
  HOST: "0.0.0.0"
  PORT: "8080"
  TIPG_CATALOG_TTL: "0"
  WEB_CONCURRENCY: "10"
